{
	"name": "ARP_Dataflow_F1",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "DataLakeTextDataset",
						"type": "DatasetReference"
					},
					"name": "drivers",
					"description": "Import drivers data"
				},
				{
					"dataset": {
						"referenceName": "DataLakeTextDataset",
						"type": "DatasetReference"
					},
					"name": "races",
					"description": "Add races data"
				},
				{
					"dataset": {
						"referenceName": "DataLakeTextDataset",
						"type": "DatasetReference"
					},
					"name": "results",
					"description": "Import results data"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "AzureSqlDataset",
						"type": "DatasetReference"
					},
					"name": "SinkToAzureSQLDB",
					"rejectedDataLinkedService": {
						"referenceName": "answer-data-academy-WorkspaceDefaultStorage",
						"type": "LinkedServiceReference"
					}
				}
			],
			"transformations": [
				{
					"name": "LeftJoinRaces",
					"description": "Left outer join 'results' and 'races'"
				},
				{
					"name": "LeftJoinDrivers"
				},
				{
					"name": "AddUUID"
				},
				{
					"name": "ConcatdriverFullname"
				},
				{
					"name": "AddYear"
				},
				{
					"name": "RemoveSurplusColumns"
				},
				{
					"name": "castPositionInteger",
					"description": "Cast position to integer"
				},
				{
					"name": "derivedColumnReplaceEndlines"
				},
				{
					"name": "filterByYear"
				}
			],
			"scriptLines": [
				"parameters{",
				"     Container as string (\"synapse\"),",
				"     Directory as string (\"alastair/f1_data\"),",
				"     DriversFileName as string (\"drivers.csv\"),",
				"     RaceFileName as string (\"races.csv\"),",
				"     ResultsFileName as string (\"results.csv\"),",
				"     DBName as string (\"DataAcademyAP\"),",
				"     FilterYear as string (\"2007\")",
				"}",
				"source(output(",
				"          driverId as short,",
				"          driverRef as string,",
				"          number as string,",
				"          code as string,",
				"          forename as string,",
				"          surname as string,",
				"          dob as date,",
				"          nationality as string,",
				"          url as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> drivers",
				"source(output(",
				"          raceId as short,",
				"          year as short,",
				"          round as short,",
				"          circuitId as short,",
				"          name as string,",
				"          date as date,",
				"          time as string,",
				"          url as string,",
				"          fp1_date as string,",
				"          fp1_time as string,",
				"          fp2_date as string,",
				"          fp2_time as string,",
				"          fp3_date as string,",
				"          fp3_time as string,",
				"          quali_date as string,",
				"          quali_time as string,",
				"          sprint_date as string,",
				"          sprint_time as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> races",
				"source(output(",
				"          resultId as short,",
				"          raceId as short,",
				"          driverId as short,",
				"          constructorId as short,",
				"          number as short,",
				"          grid as short,",
				"          position as string,",
				"          positionText as string,",
				"          positionOrder as short,",
				"          points as short,",
				"          laps as short,",
				"          time as string,",
				"          milliseconds as string,",
				"          fastestLap as string,",
				"          rank as string,",
				"          fastestLapTime as string,",
				"          fastestLapSpeed as string,",
				"          statusId as short",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false) ~> results",
				"results, races join(results@raceId == races@raceId,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> LeftJoinRaces",
				"LeftJoinRaces, drivers join(results@driverId == drivers@driverId,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> LeftJoinDrivers",
				"filterByYear derive(Id = uuid()) ~> AddUUID",
				"AddUUID derive(driverFullname = concat(forename, \" \", surname)) ~> ConcatdriverFullname",
				"ConcatdriverFullname derive(year = year(date)) ~> AddYear",
				"AddYear select(mapColumn(",
				"          Id,",
				"          year,",
				"          round,",
				"          raceName = name,",
				"          driverFullname,",
				"          code,",
				"          position,",
				"          points,",
				"          fastestLapTime",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> RemoveSurplusColumns",
				"derivedColumnReplaceEndlines cast(output(",
				"          position as integer",
				"     ),",
				"     errors: true) ~> castPositionInteger",
				"RemoveSurplusColumns derive(fastestLapTime = case(\r",
				"    fastestLapTime=='\\\\N', '00:00:00',\r",
				"    fastestLapTime!='\\\\N', fastestLapTime\r",
				"    ),",
				"          position = case(\r",
				"    position=='\\\\N', '0',\r",
				"    position!='\\\\N', position\r",
				"    )) ~> derivedColumnReplaceEndlines",
				"LeftJoinDrivers filter(year == toInteger($FilterYear)) ~> filterByYear",
				"castPositionInteger sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          Id as string,",
				"          year as integer,",
				"          round as integer,",
				"          raceName as string,",
				"          driverFullname as string,",
				"          code as string,",
				"          position as integer,",
				"          points as integer,",
				"          fastestLaptime as string",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          Id,",
				"          year,",
				"          round,",
				"          raceName,",
				"          driverFullname,",
				"          code,",
				"          position,",
				"          points,",
				"          fastestLaptime = fastestLapTime",
				"     )) ~> SinkToAzureSQLDB"
			]
		}
	}
}